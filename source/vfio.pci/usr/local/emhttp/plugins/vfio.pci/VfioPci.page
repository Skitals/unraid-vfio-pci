Menu="Utilities"
Title="VFIO-PCI Config"
Icon="microchip"
---
<style>
table.vfio thead tr:first-child td{font-size:1.1rem;text-transform:uppercase;letter-spacing:1px;}
table.vfio thead tr:last-child{border-bottom:1px solid #2b2b2b}
tr.checked { background-color: #c6eac5; color:#000; }
textarea { width:90%; }
</style>
<?php 
if (is_file("/boot/config/vfio-pci.cfg")) {
	$file = file_get_contents("/boot/config/vfio-pci.cfg");
}
$pci = array();
exec("sh /usr/local/emhttp/plugins/vfio.pci/scripts/getiommu.sh", $output, $return_var );
foreach($output as $item) {
	$iommu = substr($item, 0, 2);
	$reset = substr($item, +3, 1);
	$device = substr($item, +5, 7);
	$id = substr($item, +13,9);
	$desc = substr($item, +23);
	$pci["$iommu"]["$device"] = array( "reset" => "$reset", "id" => "$id", "desc" => "$desc" );
}
?>
<form id="vfiopci" onsubmit="return false">
<table class="vfio">
<thead>
<tr><td>IOMMU</td><td>Address</td><td>Reset</td><td>Vendor ID</td><td>Description</td></tr>
</thead>
<tbody>
<?php
$norepeat = array();
foreach($pci as $iommu => $address) {
        foreach($address as $pciaddress => $array) {
		if (strpos($file, $pciaddress) !== false) {
                	echo "<tr class=\"checked\">";
		} else {
			echo "<tr>";
		}
		echo "<td>";
		if (!in_array("$iommu",$norepeat)) {
			$str = (int)($iommu);
			echo "Group $str";
		}
		echo "</td>";
		if (strpos($file, $pciaddress) !== false) {
        		echo "<td><input type=\"checkbox\" name=\"address\" value=\"$pciaddress\" checked> $pciaddress</td>";
		} else {
			echo "<td><input type=\"checkbox\" name=\"address\" value=\"$pciaddress\"> $pciaddress</td>";
		}
        	echo "<td>";
		if ($pci[$iommu][$pciaddress]['reset'] == "1") {
			echo "[RESET]";
		}
		echo "</td>";
                echo "<td>" . $pci[$iommu][$pciaddress]['id'] . "</td>";
                echo "<td>" . $pci[$iommu][$pciaddress]['desc'] . "</td>";
		echo "</tr>";
		$norepeat[] = $iommu;
        }
}
?>
</tbody>
</table>
<input type="submit" value="Build vfio-pci.cfg" onclick="buildCfg();"><input id="savecfg" type="submit" value="Save" onclick="saveCfg();" disabled><span id="warning"></span>
</form>

<textarea id="vfio-pci-cfg" disabled><?php echo $file; ?></textarea>

<script>
$(function() {
	if ( typeof caPluginUpdateCheck === "function" ) {
		caPluginUpdateCheck("vfio.pci.plg",{name:"VFIO-PCI Config"});
	}
});

$("input[type='checkbox']").change(function() {
	if(this.checked) {
		this.closest('tr').className = "checked";
	} else {
		this.closest('tr').className = "";
	}
});

function buildCfg() {
	var string = "BIND=";
	var elements = document.getElementById("vfiopci").elements;
	for (var i = 0, element; element = elements[i++];) {
		if (element.type === "checkbox"  && element.checked === true)
        	string = string + element.value + " ";
	}
	string = string.trim();
	if (string !== "BIND=") {
		document.getElementById("vfio-pci-cfg").innerHTML = string;
	} else {
		document.getElementById("vfio-pci-cfg").innerHTML = "";
	}
		document.getElementById("savecfg").disabled = false;
		document.getElementById("warning").innerHTML = "<b>WARNING: Changes not saved. Review preview below and hit Save!</b>";
}

function saveCfg() {
	var cfg = document.getElementById("vfio-pci-cfg").innerHTML;
	$.get( "/plugins/vfio.pci/scripts/save.php", { cfg: cfg } )
	.done(function( data ) {
		alert( data );
		document.getElementById("warning").innerHTML = "<b>ALERT: Changes saved. Reboot to take effect.</b>";
	});
}
</script>
